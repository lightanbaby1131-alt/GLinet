name: Sync be3600.sh from upstream

on:
  schedule:
    - cron: "0 */12 * * *"   # 每 12 小时检查一次
  workflow_dispatch:         # 支持手动触发

jobs:
  sync-be3600:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Download be3600.sh from upstream
        run: |
          set -e
          UPSTREAM_URL="https://mt3000.netlify.app/be3600.sh"

          echo "Downloading from $UPSTREAM_URL"
          # 下载到临时文件
          if ! curl -fsSL "$UPSTREAM_URL" -o /tmp/be3600.upstream.sh; then
            echo "Upstream not reachable, skip sync."
            exit 0
          fi

          # 检查文件是否为空
          if [ ! -s /tmp/be3600.upstream.sh ]; then
            echo "Upstream file is empty, skip sync."
            exit 0
          fi

          # 如果本地还没有 be3600.sh，直接用上游的
          if [ ! -f be3600.sh ]; then
            echo "Local be3600.sh not found, using upstream version."
            mv /tmp/be3600.upstream.sh be3600.sh
            echo "NEW_FILE=1" >> $GITHUB_ENV
            exit 0
          fi

          # 比较新旧文件是否有变化
          if diff -q /tmp/be3600.upstream.sh be3600.sh >/dev/null 2>&1; then
            echo "No changes from upstream."
            exit 0
          else
            echo "Upstream has changes, updating local be3600.sh"
            mv /tmp/be3600.upstream.sh be3600.sh
            echo "UPDATED=1" >> $GITHUB_ENV
          fi

      - name: Commit and push if updated
        if: env.UPDATED == '1' || env.NEW_FILE == '1'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add be3600.sh
          git commit -m "chore: sync be3600.sh from upstream"
          git push
