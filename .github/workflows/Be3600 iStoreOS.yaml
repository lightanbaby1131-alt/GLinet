name: Build Be3600 iStoreOS Installer

on:
  workflow_dispatch:
  schedule:
    - cron: "0 22 * * *"   # æ¯å¤©æ—©ä¸Š6ç‚¹ï¼ˆä¸­å›½æ—¶é—´ï¼‰ï¼Œå¯¹åº”UTCæ—¶é—´22ç‚¹

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Prepare temp directory
        run: mkdir -p .github/temp

      - name: Download iStore packages
        run: |
          mkdir -p .github/temp/store
          wget -q -r -np -nH --cut-dirs=3 -A "*.ipk" https://repo.istoreos.com/repo/all/store/ -P .github/temp/store

      - name: Download Quickstart packages
        run: |
          mkdir -p .github/temp/quickstart
          wget -q -r -np -nH --cut-dirs=3 -A "*quickstart*.ipk" https://repo.istoreos.com/repo/all/nas_luci/ -P .github/temp/quickstart
          wget -q -r -np -nH --cut-dirs=3 -A "*quickstart*.ipk" https://repo.istoreos.com/repo/aarch64_cortex-a53/nas/ -P .github/temp/quickstart
          wget -q https://cafe.cpolar.cn/wkdaily/gl/raw/branch/main/newquickstart/quickstart_0.11.13-r1_aarch64_generic.ipk -O .github/temp/quickstart/quickstart_aarch64.ipk
          wget -q https://cafe.cpolar.cn/wkdaily/gl/raw/branch/main/newquickstart/luci-app-quickstart_0.12.4-r1_all.ipk -O .github/temp/quickstart/luci-app-quickstart.ipk
          wget -q https://cafe.cpolar.cn/wkdaily/gl/raw/branch/main/newquickstart/luci-i18n-quickstart-zh-cn_25.090.31208-f5bf244_all.ipk -O .github/temp/quickstart/luci-i18n-quickstart.ipk

      - name: Package offline installer
        run: |
          tar -czf istoreos_offline.tar.gz .github/temp
          echo '#!/bin/sh' > be3600_istoreos.run
          echo 'echo "ðŸ“¦ è§£åŽ‹å®‰è£…åŒ…..."' >> be3600_istoreos.run
          echo 'tar -xzf istoreos_offline.tar.gz -C /tmp' >> be3600_istoreos.run
          echo 'echo "âš™ï¸ å®‰è£… iStore å•†åº—..."' >> be3600_istoreos.run
          echo 'opkg install /tmp/.github/temp/store/*.ipk --force-depends' >> be3600_istoreos.run
          echo 'echo "âš™ï¸ å®‰è£… Quickstart é¦–é¡µ..."' >> be3600_istoreos.run
          echo 'opkg install /tmp/.github/temp/quickstart/*.ipk --force-depends' >> be3600_istoreos.run
          echo 'uci set system.@system[0].zonename="Asia/Shanghai"' >> be3600_istoreos.run
          echo 'uci set system.@system[0].timezone="CST-8"' >> be3600_istoreos.run
          echo 'uci commit system && /etc/init.d/system reload' >> be3600_istoreos.run
          echo 'echo "âœ… å®‰è£…å®Œæˆï¼è¯·è®¿é—® http://192.168.8.1:8080"' >> be3600_istoreos.run
          chmod +x be3600_istoreos.run

      - name: Upload artifact (fallback if no PAT)
        uses: actions/upload-artifact@v3
        with:
          name: be3600-istoreos-installer
          path: |
            istoreos_offline.tar.gz
            be3600_istoreos.run

      - name: Create Release (only if PAT is set)
        if: ${{ secrets.GH_PAT != '' }}
        id: create_release
        uses: actions/create-release@v1
        with:
          tag_name: be3600-istoreos-${{ github.run_number }}
          release_name: "Be3600 iStoreOS Installer ${{ github.run_number }}"
        env:
          GITHUB_TOKEN: ${{ secrets.GH_PAT }}

      - name: Upload tar.gz to Release
        if: ${{ secrets.GH_PAT != '' }}
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GH_PAT }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: istoreos_offline.tar.gz
          asset_name: istoreos_offline.tar.gz
          asset_content_type: application/gzip

      - name: Upload .run file to Release
        if: ${{ secrets.GH_PAT != '' }}
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GH_PAT }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: be3600_istoreos.run
          asset_name: be3600_istoreos.run
          asset_content_type: text/x-shellscript
